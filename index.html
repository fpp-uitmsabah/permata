<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Directory & Portfolio Gateway</title>

    <!-- Security Headers -->
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://generativelanguage.googleapis.com https://serpapi.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' https: data:; font-src 'self' data:; connect-src 'self' https://www.gstatic.com https://pub.orcid.org https://serpapi.com https://generativelanguage.googleapis.com https://firebasestorage.googleapis.com; media-src 'self' https://sirpoji.my; frame-ancestors 'self';">

    <meta property="og:title" content="Faculty Directory & Portfolio Gateway">
    <meta property="og:description" content="Discover distinguished faculty members from UiTM Sabah and explore their expertise.">
    <meta property="og:image" content="https://i.imgur.com/SEXIf1W.jpeg">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Faculty Directory & Portfolio Gateway">
    <meta name="twitter:description" content="Discover distinguished faculty members from UiTM Sabah and explore their expertise.">
    <meta name="twitter:image" content="https://i.imgur.com/SEXIf1W.jpeg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        /* Enhanced animations and transitions */
        .faculty-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .faculty-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .faculty-card:hover::before {
            left: 100%;
        }
        
        .faculty-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255,255,255,0.1);
        }
        
        .faculty-avatar {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .faculty-card:hover .faculty-avatar {
            transform: scale(1.1);
        }
        
        .field-badge {
            font-size: 0.75rem;
            padding: 0.4rem 1rem;
            border-radius: 50px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .field-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .field-badge:hover::before {
            left: 100%;
        }
        
        /* Enhanced field colors with gradients */
        .ekonomi { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .kewangan { 
            background: linear-gradient(135deg, #10b981, #047857);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .pemasaran { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .pengurusan { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        .pengangkutan { 
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: white;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }
        .default { 
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }
        
        .search-container {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            z-index: 10;
        }
        
        .search-input {
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .back-button {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .back-button:hover {
            transform: translateX(-4px);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            position: relative;
            overflow: hidden;
        }
        
        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Floating animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .floating {
            animation: float 6s ease-in-out infinite;
        }
        
        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Stagger animation for cards */
        .faculty-card {
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s ease forwards;
        }
        
        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Pulse effect for count */
        .count-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Enhanced scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        /* --- NEW AI Modal styles (from portfolio, adapted for light mode) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff; /* Adapted for light mode */
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        /* --- MODIFIED Button Styles --- */
        .ai-button {
            background-color: #7c3aed; /* purple-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s ease;
            margin-bottom: 0.5rem; /* Changed from margin-top/right */
            cursor: pointer;
            border: none;
        }
        .ai-button:hover {
            background-color: #6d28d9; /* purple-700 */
        }

        /* --- NEW Contact Button Style --- */
        .contact-button {
            background-color: #059669; /* green-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s ease;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border: none;
            width: 100%; /* Make it full width */
        }
        .contact-button:hover {
            background-color: #047857; /* green-700 */
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #7c3aed; /* purple-600 */
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #modalBody {
            color: #374151; /* gray-700, adapted for light mode */
            line-height: 1.6;
        }
        #modalTitle {
            color: #6d28d9; /* purple-700 */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <audio id="backgroundMusic" loop>
        <source src="https://sirpoji.my/permata-fpp-uitmsabah/uitmdihatikuinstru.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <button type="button" id="audioControl" class="fixed bottom-5 right-5 z-50 w-12 h-12 glass rounded-full text-white flex items-center justify-center hover:bg-opacity-20 transition-all duration-300" title="Toggle Music" aria-label="Toggle Background Music">
        <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M4.018 14.384A1 1 0 013 13.5V6.5a1 1 0 011.555-.832l6 3.5a1 1 0 010 1.664l-6 3.5a1 1 0 01-.537.152z"></path>
        </svg>
        <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 4h3a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V5a1 1 0 011-1zm7 0h3a1 1 0 011 1v10a1 1 0 01-1 1h-3a1 1 0 01-1-1V5a1 1 0 011-1z"></path>
        </svg>
    </button>

    <div id="app" class="min-h-screen">
        
        <div id="homepage" class="block">
            <header class="relative bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 overflow-hidden">
                <div class="absolute inset-0 bg-black opacity-10"></div>
                <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
                
                <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
                    <div class="text-center">
                        <div class="floating mb-6">
                            <div class="inline-flex items-center justify-center w-24 h-24 bg-white bg-opacity-20 rounded-full backdrop-blur-sm border border-white border-opacity-30 mb-6">
                                <img src="https://i.imgur.com/3IfJvBe.png" alt="UiTM Logo" class="w-20 h-20 object-contain">
                            </div>
                        </div>
                        <h1 class="text-5xl md:text-6xl font-bold text-white mb-4 tracking-tight">
                            FPP UiTM SABAH'S <span class="text-yellow-300">DIRECTORY</span>
                        </h1>
                        <p class="text-xl text-indigo-100 max-w-2xl mx-auto leading-relaxed">
                            Discover our distinguished faculty members and explore their expertise across various academic disciplines
                        </p>
                        <div class="mt-8 flex justify-center gap-4 items-center flex-wrap">
                            <div class="glass px-6 py-3 rounded-full">
                                <span class="text-white font-semibold">“Where Wisdom Inspires Minds, the Future Thrives”</span>
                            </div>
                            <!-- Auth button -->
                            <button type="button" id="authButton" class="bg-white text-indigo-600 px-6 py-3 rounded-full font-bold hover:bg-indigo-50 transition-all duration-300 shadow-lg">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <span id="authButtonText">Sign In</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="absolute top-10 left-10 w-20 h-20 bg-white bg-opacity-10 rounded-full blur-xl"></div>
                <div class="absolute bottom-10 right-10 w-32 h-32 bg-pink-300 bg-opacity-20 rounded-full blur-2xl"></div>
                <div class="absolute top-1/2 left-1/4 w-16 h-16 bg-yellow-300 bg-opacity-20 rounded-full blur-lg"></div>
            </header>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-0">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-8 mb-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                    
                    <div class="flex flex-col lg:flex-row gap-6 items-center">
                        <div class="search-container flex-1">
                            <div class="search-icon">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="🔍 Search faculty by name, position, or field..." 
                                class="search-input w-full pl-14 pr-6 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-20 focus:border-indigo-500 text-lg transition-all duration-300"
                            >
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <select id="fieldFilter" class="px-6 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-20 focus:border-indigo-500 text-lg transition-all duration-300">
                                <option value="">🎯 All Fields</option>
                                <option value="EKONOMI">📊 Economics</option>
                                <option value="KEWANGAN">💰 Finance</option>
                                <option value="PEMASARAN">📈 Marketing</option>
                                <option value="PENGURUSAN">👥 Management</option>
                                <option value="PENGANGKUTAN">🚛 Transportation</option>
                            </select>
                            
                            <button type="button" id="clearFilters" class="px-6 py-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-300">
                                Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex flex-col sm:flex-row justify-between items-center">
                        <div class="text-lg text-gray-700 font-medium">
                            <span class="inline-flex items-center">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                                <span id="facultyCount" class="count-pulse font-bold text-indigo-600">0</span> 
                                <span class="ml-1">faculty members found</span>
                            </span>
                        </div>
                        
                        <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                            <div class="text-sm text-gray-500">Sort by:</div>
                            <select id="sortBy" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="name">Name</option>
                                <option value="position">Position</option>
                                <option value="field">Field</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="facultyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>
        </div>

        <div id="profileView" class="hidden">
            </div>
    </div>

    <div id="aiModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4">AI Generated Content</h3>
            <div id="modalBody" class="text-gray-300 prose prose-invert max-w-none">
                </div>
            <button type="button" id="copyAiContent" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors">Copy to Clipboard</button>
            <button type="button" id="closeModal" class="mt-6 ml-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors">Close</button>
        </div>
    </div>

    <div id="contactModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="contactModalTitle" class="text-2xl font-bold mb-4" style="color: #059669;">Initiate Contact</h3>
            <p class="mb-6 text-gray-600">Your details will be forwarded to this faculty member.</p>
            <form id="contactForm">
                <div class="mb-4">
                    <label for="contactEmail" class="block text-sm font-medium text-gray-700 mb-2">Your Email*</label>
                    <input type="email" id="contactEmail" name="email" placeholder="you@example.com" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-4">
                    <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-2">Your Contact Number</label>
                    <input type="tel" id="contactPhone" name="phone" placeholder="+60 12-345 6789" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-6">
                    <label for="contactMessage" class="block text-sm font-medium text-gray-700 mb-2">Message (Optional)</label>
                    <textarea id="contactMessage" name="message" rows="4" placeholder="I'm interested in collaborating on..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="closeContactModal" class="mt-6 ml-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors">Cancel</button>
                    <button type="submit" id="submitContactForm" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors">Submit</button>
                </div>
            </form>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-indigo-600">Faculty Sign In</h3>
            <p class="text-gray-600 mb-6">Sign in to access editable portfolio content</p>
            
            <!-- Google Sign In Tab -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Sign in with Google</h4>
                <p class="text-sm text-gray-500 mb-3">Use your @uitm.edu.my email address</p>
                <button type="button" id="googleSignInButton" class="w-full bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-all duration-300 flex items-center justify-center">
                    <svg class="w-6 h-6 mr-3" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>

            <!-- Staff ID Section -->
            <div class="border-t pt-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Alternative: Staff ID</h4>
                <p class="text-sm text-gray-500 mb-3">Enter your staff ID to verify access</p>
                <form id="staffIdForm" class="space-y-3">
                    <div>
                        <label for="staffIdInput" class="block text-sm font-medium text-gray-700 mb-1">Staff ID</label>
                        <input type="text" id="staffIdInput" placeholder="e.g., 346353" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-all duration-300">
                        Verify Staff ID
                    </button>
                </form>
            </div>

            <div class="mt-6 pt-6 border-t">
                <p class="text-sm text-gray-500 mb-3" id="authStatus"></p>
                <button type="button" id="closeAuthModal" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

<script>
        // WARNING: API keys should be moved to environment variables and accessed via a backend server
        // These keys are currently exposed and should be rotated immediately
        // TODO: Implement backend API to securely handle API calls
        
        // Firebase configuration - SECURITY WARNING: Should be in environment variables
        const firebaseConfig = {
            apiKey: "AIzaSyBw3CzBbdO49NpxkOqAmVI596nuB9wmt8w", // TODO: Move to backend
            authDomain: "academiq-9c9zg.firebaseapp.com",
            projectId: "academiq-9c9zg",
            storageBucket: "academiq-9c9zg.firebasestorage.app",
            messagingSenderId: "779034912138",
            appId: "1:779034912138:web:b2bdd60d01622bf9261473",
            measurementId: "G-DGZHBZBYLW"
        };

        // Initialize Firebase with error handling
        try {
            firebase.initializeApp(firebaseConfig);
            // Remove detailed logging in production
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log("Firebase initialized");
            }
        } catch (error) {
            // Don't expose error details in production
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.error("Firebase initialization failed:", error);
            }
        }

        // ======================
        // AUTHENTICATION SYSTEM
        // ======================
        let auth;
        let currentAuthUser = null;
        let currentFacultyProfile = null;

        // Initialize Firebase Auth
        try {
            auth = firebase.auth();
            
            // Configure Google provider to only allow uitm.edu.my domain
            const googleProvider = new firebase.auth.GoogleAuthProvider();
            googleProvider.setCustomParameters({
                'hd': 'uitm.edu.my' // Hosted domain - restricts to uitm.edu.my
            });
            
            // Auth state observer
            auth.onAuthStateChanged((user) => {
                currentAuthUser = user;
                updateAuthUI(user);
                
                if (user) {
                    // Check if email is from uitm.edu.my
                    if (user.email && user.email.endsWith('@uitm.edu.my')) {
                        matchUserToFaculty(user.email);
                    } else {
                        console.warn('User email is not from @uitm.edu.my domain');
                        auth.signOut();
                        showAuthStatus('Please sign in with your @uitm.edu.my email address', 'error');
                    }
                }
            });
        } catch (error) {
            console.error('Auth initialization error:', error);
        }

        // Match signed-in user to faculty data
        function matchUserToFaculty(email) {
            const faculty = facultyData.find(f => 
                f.email && f.email.toLowerCase() === email.toLowerCase()
            );
            
            if (faculty) {
                currentFacultyProfile = faculty;
                showAuthStatus(`Welcome, ${faculty.name}! You can now access your portfolio with edit permissions.`, 'success');
                // Store in session storage for portfolio pages to access
                sessionStorage.setItem('authenticatedUser', JSON.stringify({
                    email: email,
                    employeeId: faculty.employee_id,
                    name: faculty.name,
                    canEdit: true
                }));
            } else {
                showAuthStatus('Your email is not associated with any faculty profile in our directory.', 'warning');
                currentFacultyProfile = null;
            }
        }

        // Verify staff ID against faculty data
        function verifyStaffId(staffId) {
            const faculty = facultyData.find(f => 
                f.employee_id && f.employee_id === staffId
            );
            
            if (faculty) {
                currentFacultyProfile = faculty;
                showAuthStatus(`Verified! Staff ID matches ${faculty.name}. You can now access your portfolio with edit permissions.`, 'success');
                // Store in session storage
                sessionStorage.setItem('authenticatedUser', JSON.stringify({
                    email: faculty.email,
                    employeeId: faculty.employee_id,
                    name: faculty.name,
                    canEdit: true,
                    authMethod: 'staffId'
                }));
                return true;
            } else {
                showAuthStatus('Staff ID not found in our directory.', 'error');
                return false;
            }
        }

        // Update auth UI
        function updateAuthUI(user) {
            const authButton = document.getElementById('authButton');
            const authButtonText = document.getElementById('authButtonText');
            
            if (user) {
                authButtonText.textContent = 'Sign Out';
                authButton.classList.remove('bg-white', 'text-indigo-600');
                authButton.classList.add('bg-green-500', 'text-white');
            } else {
                authButtonText.textContent = 'Sign In';
                authButton.classList.remove('bg-green-500', 'text-white');
                authButton.classList.add('bg-white', 'text-indigo-600');
                currentFacultyProfile = null;
                sessionStorage.removeItem('authenticatedUser');
            }
        }

        // Show auth status messages
        function showAuthStatus(message, type = 'info') {
            const authStatus = document.getElementById('authStatus');
            if (!authStatus) return;
            
            authStatus.textContent = message;
            authStatus.className = 'text-sm mb-3 ';
            
            if (type === 'success') {
                authStatus.className += 'text-green-600 font-semibold';
            } else if (type === 'error') {
                authStatus.className += 'text-red-600 font-semibold';
            } else if (type === 'warning') {
                authStatus.className += 'text-yellow-600 font-semibold';
            } else {
                authStatus.className += 'text-gray-600';
            }
        }

        // Google Sign In
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({
                'hd': 'uitm.edu.my'
            });
            
            try {
                showAuthStatus('Signing in...', 'info');
                const result = await auth.signInWithPopup(provider);
                
                // Verify domain
                if (!result.user.email.endsWith('@uitm.edu.my')) {
                    await auth.signOut();
                    showAuthStatus('Please use your @uitm.edu.my email address', 'error');
                    return;
                }
                
                closeAuthModal();
            } catch (error) {
                console.error('Google sign-in error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showAuthStatus('Sign-in cancelled', 'info');
                } else {
                    showAuthStatus('Sign-in failed. Please try again.', 'error');
                }
            }
        }

        // Sign Out
        async function signOut() {
            try {
                await auth.signOut();
                currentFacultyProfile = null;
                sessionStorage.removeItem('authenticatedUser');
                showAuthStatus('Signed out successfully', 'info');
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        }

        // Modal controls
        function openAuthModal() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.classList.add('active');
                showAuthStatus('', 'info');
            }
        }

        function closeAuthModal() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.classList.remove('active');
            }
        }

        // ======================
        // END AUTHENTICATION SYSTEM
        // ======================

        // SECURITY WARNING: API keys should never be in client-side code
        // TODO: Move to backend server with proper authentication
        const GEMINI_API_KEY = "AIzaSyBdWyxRzeffdUVmajEHkJWLOXKvc6kzR2M"; // TODO: Move to backend
        const GEMINI_API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
        const SERPAPI_KEY = '5a5241bc4ea3fb190a940eaabfa8d43d515cd59e71fc036c790c432f5df0a241'; // TODO: Move to backend

        // HTML Sanitization Helper Function
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // URL validation helper
        function isValidURL(string) {
            try {
                const url = new URL(string);
                return url.protocol === "http:" || url.protocol === "https:";
            } catch (_) {
                return false;
            }
        }

        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Faculty data with added orcidId, scholarId, scopusId, wosId, adScientificId, googleDriveLink where available
        const facultyData = [
            {
                "name": "ASSOCIATE PROFESSOR DR ROZITA@UJI MOHAMMED", "position": "ACTING RECTOR", "field": "KEWANGAN", "phone": "088 - 325151", "imageUrl": "https://i.imgur.com/AfTwVHA.png", "isRector": true, "path": "https://fpp-uitmsabah.github.io/permata/rozita.html", "scholarId": "X8mOPWwAAAAJ", "email": "rozlim97@uitm.edu.my", "employee_id": "162582"
            },
            {
                "name": "PROFESOR TS. DR. IMBARINE BIN HJ BUJANG, JP", "position": "PROFESOR (VK7)", "field": "KEWANGAN", "phone": "088 - 325151", "imageUrl": "https://i.imgur.com/yK4vFQ9.png", "distinguished": true, "path": "https://fpp-uitmsabah.github.io/permata/imbarine.html", "scholarId": "PQPF3kkAAAAJ", "orcidId": "0000-0002-1427-0963", "email": "imbar074@uitm.edu.my", "employee_id": "272074"
            },
            {
                "name": "ASSOCIATE PROFESSOR DR SYLVIA@ NABILA AZWA AMBAD", "position": "PROFESOR MADYA", "field": "KEUSAHAWANAN", "phone": "088 - 325151", "imageUrl": "https://i.imgur.com/R4QSvdh.png", "distinguished": true, "path": "https://fpp-uitmsabah.github.io/permata/nabila.html", "scholarId": "P0Q0iT0AAAAJ", "orcidId": "0000-0003-1693-8514", "wosId": "AAN-4346-2021", "scopusId": "57190841191", "adScientificId": "331732", "email": "nabila1793@uitm.edu.my", "employee_id": "317201"
            },
            {
                "name": "ASSOCIATE PROFESSOR DR IMELDA ALBERT GISIP", "position": "PROFESOR MADYA", "field": "PEMASARAN", "phone": "088 - 325151", "imageUrl": "https://i.imgur.com/56wH97R.jpeg", "isMarketingExpert": true, "path": "https://fpp-uitmsabah.github.io/permata/imelda.html", "scholarId": "ZKyK4ocAAAAJ", "email": "imeldag@uitm.edu.my", "employee_id": "215316"
            },
            {
                "name": "ASSOCIATE PROFESSOR DR ABDUL AZIZ KARIA", "position": "PROFESOR MADYA", "field": "EKONOMI", "phone": "088 - 325151", "imageUrl": "https://i.imgur.com/pIBl3hM.png", "isEconomist": true, "path": "https://fpp-uitmsabah.github.io/permata/azizkaria.html", "scholarId": "wEU9sPoAAAAJ", "orcidId": "0000-0002-4888-682X", "email": "abdulaziz@uitm.edu.my", "employee_id": "319872"
            },
            {
                "name": "ASSOCIATE PROFESSOR DR NOORZIAH MOHD SALLEH", "position": "PROFESOR MADYA", "field": "PENGURUSAN", "phone": "088 - 325151", "imageUrl": "https://i.imgur.com/YzT5qni.png", "isHumanCapitalExpert": true, "path": "https://fpp-uitmsabah.github.io/permata/noorziah.html", "orcidId": "0000-0003-0243-3443", "scholarId": "UEdCve8AAAAJ", "email": "noorziah@uitm.edu.my", "employee_id": "168544"
            },
            {
                "name": "DR DEWI BINTI TAJUDDIN", "position": "PENSYARAH KANAN", "field": "PENGURUSAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/dewi.html", "imageUrl": "https://i.imgur.com/KAwa8sg.png", "scholarId": "T2gMxekAAAAJ", "email": "dewi400@uitm.edu.my", "employee_id": "309400"
            },
            {
                "name": "DR SITI RAHAYU BINTI BELI", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/rahayu.html", "imageUrl": "https://i.imgur.com/gnIUTT6.png", "orcidId": "0000-0001-6555-570X", "email": "rahayu@uitm.edu.my", "employee_id": "331135"
            },
            {
                "name": "DR RAINAH GINSAD", "position": "PENSYARAH KANAN", "field": "EKONOMI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/rainah.html", "imageUrl": "https://i.imgur.com/wY54IiY.png", "scholarId": "DTVW8oMAAAAJ", "email": "rainahgi@uitm.edu.my", "employee_id": "160720"
            },
            {
                "name": "DR JASMINE VIVIENNE ANDREW", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/jasmine.html", "imageUrl": "https://i.imgur.com/RPrDp9X.png", "scholarId": "_zG17NIAAAAJ", "orcidId": "0000-0001-9872-5963", "email": "jasmineva@uitm.edu.my", "employee_id": "259660"
            },
            {
                "name": "DR SARMILA UDIN", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/sarmila.html", "imageUrl": "https://i.imgur.com/hH2M9wI.png", "scholarId": "EgBvSlQAAAAJ", "email": "sarmil370@uitm.edu.my", "employee_id": "277370"
            },
            {
                "name": "DR FLICIA RIMIN", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/flicia.html", "imageUrl": "https://i.imgur.com/Lt3PoS4.png", "scholarId": "u91NzqEAAAAJ", "orcidId": "0000-0001-8720-2227", "email": "flicia885@uitm.edu.my", "employee_id": "319885"
            },
            {
                "name": "DR RAPHEEDAH MUSNEH", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/rapheedah.html", "imageUrl": "https://i.imgur.com/4AU1ScM.png", "email": "raphe473@uitm.edu.my", "employee_id": "255473"
            },
            {
                "name": "DR SHARIFAH NURAFIZAH SYED ANNUAR", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/sharifah.html", "imageUrl": "https://i.imgur.com/mZx1OJe.png", "scholarId": "IQ3ZUJUAAAAJ", "orcidId": "0000-0001-7494-3333", "email": "shari339@uitm.edu.my", "employee_id": "250339"
            },
            {
                "name": "DR ABDUL AZIZ LAI MOHD FIKRI LAI", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325213", "path": "https://fpp-uitmsabah.github.io/permata/azizlai.html", "imageUrl": "https://i.imgur.com/6Fx6Uc8.jpeg", "scholarId": "3X8Dic4AAAAJ", "orcidId": "0000-0001-8718-5148", "email": "abdulazizlai@uitm.edu.my", "employee_id": "339674"
            },
            {
                "name": "AHMAD FAUZE ABDUL HAMIT", "position": "PENSYARAH", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/fauze.html", "imageUrl": "https://i.imgur.com/wvOF6kd.jpeg", "scholarId": "eJvlXzIAAAAJ", "orcidId": "0000-0002-4343-6037", "wosId": "JVD-7667-2023", "email": "ahmad920@uitm.edu.my", "employee_id": "346353"
            },
            {
                "name": "AHMAD GHAZALI BIN ISMAIL", "position": "PENSYARAH", "field": "EKONOMI", "phone": "088 - 513867", "path": "https://fpp-uitmsabah.github.io/permata/ghazali.html", "imageUrl": "https://i.imgur.com/6vXlmtW.jpeg", "scholarId": "3WpZ5zUAAAAJ", "orcidId": "0000-0001-8088-6275", "email": "ahmad2355@uitm.edu.my", "employee_id": "335021"
            },
            {
                "name": "ANASTASIAH BINTI HARBI", "position": "PENSYARAH", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/anastasia.html", "imageUrl": "https://i.imgur.com/AAs2gaX.jpeg", "email": "anastasiah026@uitm.edu.my", "employee_id": "314026"
            },
            {
                "name": "DR CYNTHIA @ ANNAMARIA ROBERT DAWAYAN", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/cynthia.html", "imageUrl": "https://i.imgur.com/n748h8z.png", "scholarId": "QFPJ7qQAAAAJ", "orcidId": "0000-0001-8497-2699", "email": "cynthia@uitm.edu.my", "employee_id": "215264"
            },
            {
                "name": "CYRIL SUPAIN @ CHRISTOPHER", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/cyril.html", "imageUrl": "https://i.imgur.com/aBd1Bme.jpeg", "email": "cyril489@uitm.edu.my", "employee_id": "249489"
            },
            {
                "name": "DR DAYANG HARYANI DIANA BT AG DAMIT", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/dayang.html", "imageUrl": "https://i.imgur.com/Q66orWt.jpeg", "scholarId": "LZ7JqvoAAAAJ", "orcidId": "0000-0002-7824-8087", "email": "dayan457@uitm.edu.my", "employee_id": "255457"
            },
            {
                "name": "DG KAMISAH BINTI AG BUDIN", "position": "PENSYARAH KANAN", "field": "PENGURUSAN SUMBER MANUSIA", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/dgkamisah.html", "imageUrl": "https://i.imgur.com/LLv1xol.jpeg", "scholarId": "G68gNywAAAAJ", "email": "dgkam548@uitm.edu.my", "employee_id": "303862"
            },
            {
                "name": "DGKU ALMAHIRAH AWANG KEE", "position": "PENSYARAH", "field": "PENGURUSAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/dgkualmahirah.html", "imageUrl": "#", "email": "dgkua5583@uitm.edu.my", "employee_id": "340692"
            },
            {
                "name": "FAIQAH BINTI MAWARDI", "position": "PENSYARAH KANAN", "field": "PENGURUSAN OPERASI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/faiqah.html", "imageUrl": "https://i.imgur.com/IojOXXu.jpeg", "scholarId": "uoK9CtAAAAAJ", "email": "faiqah716@uitm.edu.my", "employee_id": "307716"
            },
            {
                "name": "FARIDAH BINTI MOHD SHAH", "position": "PENSYARAH", "field": "PENGURUSAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/faridah.html", "imageUrl": "https://i.imgur.com/9kyxtX1.jpeg", "orcidId": "0000-0002-0790-9626", "email": "farida7572@uitm.edu.my", "employee_id": "324977"
            },
            {
                "name": "FRANKLIN HAZLEY LAI", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/franklin.html", "imageUrl": "https://i.imgur.com/FUaqmnE.jpeg", "email": "frank985@uitm.edu.my", "employee_id": "248985"
            },
            {
                "name": "DR HASNAWATI HAJI GULILING", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/hasnawati.html", "imageUrl": "https://i.imgur.com/YqCHyq5.jpeg", "orcidId": "0000-0002-4860-1820", "email": "hgss@uitm.edu.my", "employee_id": "150549"
            },
            {
                "name": "HERNIZA ROXANNE MARCUS", "position": "PENSYARAH", "field": "EKONOMI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/herniza.html", "imageUrl": "https://i.imgur.com/B2WoXT6.jpeg", "email": "herniza593@uitm.edu.my", "employee_id": "331122"
            },
            {
                "name": "DR HYLMEE MATAHIR", "position": "PENSYARAH KANAN", "field": "EKONOMI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/hylmee.html", "imageUrl": "https://i.imgur.com/KzSNZUc.jpeg", "email": "hylme703@uitm.edu.my", "employee_id": "271703"
            },
            {
                "name": "DR JAIN YASSIN", "position": "PENSYARAH KANAN", "field": "EKONOMI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/jain.html", "imageUrl": "https://i.imgur.com/iyNGGCy.jpeg", "orcidId": "0000-0002-4190-5960", "email": "jainyassin@uitm.edu.my", "employee_id": "349826"
            },
            {
                "name": "DR JASMAN TUYON", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/jasman.html", "imageUrl": "https://i.imgur.com/4u4oIcY.jpeg", "email": "jasma402@uitm.edu.my", "employee_id": "255402"
            },
            {
                "name": "KAMARULZAMAN B ISHAK", "position": "PENSYARAH KANAN", "field": "PENGANGKUTAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/kamarulzaman.html", "imageUrl": "https://i.imgur.com/ojqbTPz.jpeg", "email": "kamar365@uitm.edu.my", "employee_id": "143365"
            },
            {
                "name": "DR JACQUELINE KOH SIEW LEN BTE STEPHEN", "position": "PENSYARAH KANAN", "field": "PENGURUSAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/jacqueline.html", "imageUrl": "https://i.imgur.com/jeP92pB.jpeg", "email": "jacqu807@uitm.edu.my", "employee_id": "193807"
            },
            {
                "name": "KHAIRIAH MAZDIAH BINTI KALIMIN", "position": "PENSYARAH", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/khairiah.html", "imageUrl": "https://i.imgur.com/ISFXj5V.jpeg", "email": "khair5577@uitm.edu.my", "employee_id": "323826"
            },
            {
                "name": "MARYAM QAAMEELAH OTHMAN", "position": "PENSYARAH", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/maryam.html", "imageUrl": "https://i.imgur.com/cwzclWd.jpeg", "email": "qaameelah@uitm.edu.my", "employee_id": "346272"
            },
            {
                "name": "MOHAMAD ZULFADHLI BIN JUSOH", "position": "PENSYARAH", "field": "PENGANGKUTAN", "phone": "088 - 951611", "path": "https://fpp-uitmsabah.github.io/permata/zulfadhli.html", "imageUrl": "https://i.imgur.com/UNWImiZ.jpeg", "email": "zulfadhlijusoh@uitm.edu.my", "employee_id": "349525"
            },
            {
                "name": "MOHAMMAD FIRDAUS BIN MOHAMAD", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/firdaus.html", "imageUrl": "https://i.imgur.com/T2BGkeh.jpeg", "email": "moham2373@uitm.edu.my", "employee_id": "308359"
            },
            {
                "name": "DR MAILY PATRICK", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/maily.html", "imageUrl": "https://i.imgur.com/KFn1sic.jpeg", "email": "maily@uitm.edu.my", "employee_id": "346324"
            },
            {
                "name": "DR MOHD ADZWIN FARIS NIASIN", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/adzwin.html", "imageUrl": "https://i.imgur.com/fpzCzj9.jpeg", "email": "adzwin_faris@uitm.edu.my", "employee_id": "348908"
            },
            {
                "name": "MYDAH @ MYLENDA ERIC", "position": "PENSYARAH KANAN", "field": "PENGURUSAN OPERASI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/mydah.html", "imageUrl": "#", "email": "mydah@uitm.edu.my", "employee_id": "368470" 
            },
            {
                "name": "NINALYN FRIDRICT", "position": "PENSYARAH", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/ninalyn.html", "imageUrl": "https://i.imgur.com/j8qifBN.jpeg", "email": "ninalyn9564@uitm.edu.my", "employee_id": "346298"
            },
            {
                "name": "NURUL HIDAYAH MAT NOR", "position": "PENSYARAH KANAN", "field": "EKONOMI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/hidayah.html", "imageUrl": "#", "email": "hidayahmatnor@uitm.edu.my", "employee_id": "288136"
            },
            {
                "name": "NUR HAZILAH OMAR", "position": "PENSYARAH", "field": "PENGURUSAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/hazilah.html", "imageUrl": "https://i.imgur.com/LSw0Z0g.jpeg", "email": "nurha234@uitm.edu.my", "employee_id": "346256"
            },
            {
                "name": "DR PG. MOHD AUZA'E BIN PG ARSHAD", "position": "PENSYARAH KANAN", "field": "PENGURUSAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/auzae.html", "imageUrl": "https://i.imgur.com/ylpeVSG.jpeg", "email": "mohdauzae@uitm.edu.my", "employee_id": "270283"
            },
            {
                "name": "DR NORNAJIHAH NADIA HASBULLAH", "position": "PENSYARAH KANAN", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/nornajihah.html", "imageUrl": "https://i.imgur.com/4v3GwBm.jpeg", "scholarId": "ypjhvzcAAAAJ", "orcidId": "0000-0002-6097-9981", "wosId": "AFI-9812-2022", "scopusId": "57216148170", "googleDriveLink": "https://drive.google.com/open?id=1h_Z56SST-31mgOqKOWgD4M490PGrsY3p", "email": "najihahnadia@uitm.edu.my", "employee_id": "366566"
            },
            {
                "name": "DR MOHD RAZUAN BIN ABD HISHAMUDDIN", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/razuan.html", "imageUrl": "https://i.imgur.com/pYidT6V.jpeg", "email": "mrazuan@uitm.edu.my", "employee_id": "384069"
            },
            {
                "name": "DR TAUFIK ABD HAKIM", "position": "PENSYARAH KANAN", "field": "EKONOMI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/taufik.html", "imageUrl": "https://i.imgur.com/8m4ozuO.jpeg", "email": "taufik4955@uitm.edu.my", "employee_id": "320337"
            },
            {
                "name": "MOHD ROZIE MOHD DAMIT", "position": "PENSYARAH KANAN", "field": "KEWANGAN", "phone": "088 - 325151", "imageUrl": "https://i.imgur.com/BHVplSw.png", "path": "https://fpp-uitmsabah.github.io/permata/rozie.html", "email": "mohdrozie@uitm.edu.my", "employee_id": "385343"
            },
            {
                "name": "SITI JULEA BINTI SUPAR", "position": "PENSYARAH", "field": "KEWANGAN", "phone": "088 - 325219", "path": "https://fpp-uitmsabah.github.io/permata/sitijulea.html", "imageUrl": "https://i.imgur.com/T9WUIx4.jpeg", "email": "julea@uitm.edu.my", "employee_id": "342263"
            },
            {
                "name": "SUMAFFIATIE SULONG", "position": "PENSYARAH KANAN", "field": "EKONOMI", "phone": "088 - 325219", "path": "https://fpp-uitmsabah.github.io/permata/sumaffiatie.html", "imageUrl": "https://i.imgur.com/4jYnFqX.jpeg", "email": "sumaff@uitm.edu.my", "employee_id": "139081"
            },
            {
                "name": "NUR SHAHAFIQAH NADIAH BINTI JAFFERY", "position": "PENSYARAH", "field": "PEMASARAN", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/nurshahafiqah.html", "imageUrl": "https://i.imgur.com/w5Qc4D5.jpeg", "email": "shahafiqah@uitm.edu.my", "employee_id": "383329"
            },
            {
                "name": "HJ. S. JUNAIDI BIN MOHAMMAD", "position": "PENSYARAH KANAN", "field": "EKONOMI", "phone": "088 - 325151", "path": "https://fpp-uitmsabah.github.io/permata/junaidi.html", "imageUrl": "#", "email": "sheikhju@uitm.edu.my", "employee_id": "150578"
            },
            {
                "name": "SUALI @ SUHAILIE BAKRIN", "position": "PENSYARAH", "field": "PENGURUSAN", "phone": "088 - 513870", "path": "https://fpp-uitmsabah.github.io/permata/suali.html", "imageUrl": "https://i.imgur.com/yHMd3b4.jpeg", "email": "suali7548@uitm.edu.my", "employee_id": "340139"
            },
            {
                "name": "MELINDA AZZALEA TAI ABDULLAH @ TAI NYUK CHIN", "position": "PENSYARAH", "field": "EKONOMI", "phone": "088 - 325102", "path": "https://fpp-uitmsabah.github.io/permata/melinda.html", "imageUrl": "https://i.imgur.com/f5olmQB.jpeg", "email": "tainy505@uitm.edu.my", "employee_id": "275505"
            }
        ];

        let filteredFaculty = [...facultyData];

        // Fetch ORCID works (publications)
        async function fetchOrcidWorks(orcidId) {
            if (!orcidId) return null;
            try {
                const response = await fetch(`https://pub.orcid.org/v3.0/${orcidId}/works`);
                if (!response.ok) return null;
                const data = await response.json();
                return data['group']?.map(group => ({
                    title: group['work-summary'][0]['title']['title']['value'],
                    year: group['work-summary'][0]['publication-date']['year']['value'],
                    type: group['work-summary'][0]['type']
                })) || [];
            } catch (error) {
                console.error('ORCID fetch error:', error);
                return null;
            }
        }

        // Fetch Google Scholar data via SerpApi
        async function fetchScholarData(scholarId, apiKey) {
            if (!scholarId || !apiKey) return null;
            try {
                const params = new URLSearchParams({
                    engine: 'google_scholar_author',
                    author_id: scholarId,
                    api_key: apiKey
                });
                const response = await fetch(`https://serpapi.com/search?${params}`);
                if (!response.ok) return null;
                const data = await response.json();
                return {
                    citedBy: data['cited_by'] || 0,
                    publications: data['publications']?.slice(0, 5) || []
                };
            } catch (error) {
                console.error('Scholar fetch error:', error);
                return null;
            }
        }

        // Fetch Scopus data via SerpApi
        async function fetchScopusData(scopusId, apiKey) {
            if (!scopusId || !apiKey) return null;
            try {
                const params = new URLSearchParams({
                    engine: 'scopus',
                    author_id: scopusId,
                    api_key: apiKey
                });
                const response = await fetch(`https://serpapi.com/search?${params}`);
                if (!response.ok) return null;
                const data = await response.json();
                return {
                    hIndex: data['h-index'] || 0,
                    citedBy: data['cited_by'] || 0,
                    publications: data['publications']?.slice(0, 5) || []
                };
            } catch (error) {
                console.error('Scopus fetch error:', error);
                return null;
            }
        }

        // Fetch Web of Science data via SerpApi
        async function fetchWosData(wosId, apiKey) {
            if (!wosId || !apiKey) return null;
            try {
                const params = new URLSearchParams({
                    engine: 'web_of_science',
                    author_id: wosId,
                    api_key: apiKey
                });
                const response = await fetch(`https://serpapi.com/search?${params}`);
                if (!response.ok) return null;
                const data = await response.json();
                return {
                    citedBy: data['cited_by'] || 0,
                    publications: data['publications']?.slice(0, 5) || []
                };
            } catch (error) {
                console.error('WoS fetch error:', error);
                return null;
            }
        }

        // Fetch AD Scientific Index data (placeholder - may require custom API or scraping, but using SerpApi if possible)
        async function fetchAdScientificData(adScientificId, apiKey) {
            if (!adScientificId || !apiKey) return null;
            try {
                // Assuming SerpApi has a way, but for now, placeholder
                const params = new URLSearchParams({
                    engine: 'google',  // Fallback to Google search for AD Scientific
                    q: `site:adsciencelibrary.com ${adScientificId}`,
                    api_key: apiKey
                });
                const response = await fetch(`https://serpapi.com/search?${params}`);
                if (!response.ok) return null;
                const data = await response.json();
                // Parse results as needed
                return {
                    rank: data['organic_results']?.[0]?.snippet || 'N/A'
                };
            } catch (error) {
                console.error('AD Scientific fetch error:', error);
                return null;
            }
        }

        // Cache helper
        function getCached(key, ttl = 3600000) {  // 1 hour TTL
            const item = localStorage.getItem(key);
            if (!item) return null;
            const { data, timestamp } = JSON.parse(item);
            return Date.now() - timestamp < ttl ? data : null;
        }

        function setCached(key, data) {
            localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
        }

        // Get field class for styling
        function getFieldClass(field) {
            const fieldMap = {
                'EKONOMI': 'ekonomi',
                'KEWANGAN': 'kewangan',
                'PEMASARAN': 'pemasaran',
                'PENGURUSAN': 'pengurusan',
                'PENGURUSAN SUMBER MANUSIA': 'pengurusan',
                'PENGURUSAN OPERASI': 'pengurusan',
                'PENGANGKUTAN': 'pengangkutan'
            };
            return fieldMap[field] || 'default';
        }

        // Generate initials for avatar
        function getInitials(name) {
            return name.split(' ')
                .filter(word => word.length > 2)
                .slice(0, 2)
                .map(word => word[0])
                .join('');
        }

        // Get gradient colors for cards
        function getCardGradient(index) {
            const gradients = [
                'from-purple-600 via-pink-500 to-red-500',
                'from-blue-600 via-indigo-500 to-purple-500',
                'from-green-500 via-emerald-500 to-teal-500',
                'from-orange-500 via-red-500 to-pink-500',
                'from-indigo-600 via-purple-600 to-pink-500',
                'from-cyan-500 via-blue-500 to-indigo-500',
                'from-yellow-500 via-orange-500 to-red-500',
                'from-emerald-500 via-green-500 to-teal-500',
                'from-pink-500 via-rose-500 to-red-500',
                'from-violet-600 via-purple-600 to-indigo-600'
            ];
            return gradients[index % gradients.length];
        }

        // Create faculty card with sanitization
        function createFacultyCard(faculty, index) {
            // Sanitize all user-facing content
            const initials = getInitials(sanitizeHTML(faculty.name));
            const delay = (index % 12) * 0.1; // Stagger animation
            const cardGradient = getCardGradient(index);
            
            const isDistinguished = !!faculty.path;
            // Validate URL before using
            const profileImage = (faculty.imageUrl && isValidURL(faculty.imageUrl)) ? faculty.imageUrl : '';
            const facultyIndex = facultyData.indexOf(faculty);
            
            // Sanitize all dynamic content
            const sanitizedName = sanitizeHTML(faculty.name);
            const sanitizedPosition = sanitizeHTML(faculty.position);
            const sanitizedField = sanitizeHTML(faculty.field);
            const sanitizedPhone = sanitizeHTML(faculty.phone);
            const sanitizedPath = faculty.path && isValidURL(faculty.path) ? faculty.path : '#';
            
            return `
                <div class="faculty-card bg-gradient-to-r ${cardGradient} rounded-3xl shadow-2xl p-8 relative group overflow-hidden" 
                    onclick="window.open('${sanitizedPath}', '_blank')" 
                    style="animation-delay: ${delay}s;">
                    
                    <div class="absolute inset-0 bg-black opacity-10"></div>
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white bg-opacity-10 rounded-full -translate-y-16 translate-x-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-white bg-opacity-10 rounded-full translate-y-12 -translate-x-12"></div>
                    
                    <div class="relative z-10">
                        <div class="flex flex-col space-y-6">
                            <div class="flex items-start justify-between">
                                <div class="faculty-avatar relative">
                                    ${profileImage ? `
                                        <div class="w-24 h-24 rounded-3xl overflow-hidden backdrop-blur-sm border-4 border-white border-opacity-30 shadow-2xl">
                                            <img src="${profileImage}" alt="${sanitizedName}" class="w-full h-full object-cover" loading="lazy">
                                        </div>
                                    ` : `
                                        <div class="w-24 h-24 bg-white bg-opacity-20 rounded-3xl flex items-center justify-center text-white font-bold text-2xl backdrop-blur-sm border-4 border-white border-opacity-30">
                                            ${initials}
                                        </div>
                                    `}
                                    <div class="absolute -bottom-2 -right-2 w-8 h-8 ${isDistinguished ? 'bg-yellow-400' : 'bg-green-400'} rounded-full border-3 border-white flex items-center justify-center shadow-lg">
                                        ${isDistinguished ? `
                                            <svg class="w-4 h-4 text-yellow-900" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                        ` : `
                                            <svg class="w-4 h-4 text-green-900" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                        `}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-white">
                                <h3 class="text-2xl font-bold mb-2 leading-tight group-hover:text-yellow-200 transition-colors duration-300">
                                    ${sanitizedName}
                                </h3>
                                <p class="text-lg font-medium mb-4 text-white text-opacity-90">
                                    ${sanitizedPosition}
                                </p>
                                
                                <div class="flex items-center justify-between mb-6">
                                    <span class="bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm font-medium backdrop-blur-sm border border-white border-opacity-30">
                                        ${sanitizedField}
                                    </span>
                                </div>
                                
                                <div class="flex items-center text-white text-opacity-90 mb-6">
                                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    <span class="font-medium">${sanitizedPhone}</span>
                                </div>
                                
                                <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 backdrop-blur-sm border border-white border-opacity-30 mb-2">
                                    View Full Portfolio →
                                </button>

                                <button onclick="handleContactClick(event, ${facultyIndex})" class="contact-button" title="Initiate contact with ${sanitizedName}">
                                    🔗 Initiate Contact
                                </button>
                                
                                <button onclick="handleAiClick(event, ${facultyIndex}, 'pitch')" class="ai-button w-full" title="Generate AI Collaboration Pitch">
                                    ✨ Curious? (AI Pitch)
                                </button>
                                
                                </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // Render faculty grid
        function renderFacultyGrid() {
            const grid = document.getElementById('facultyGrid');
            grid.innerHTML = filteredFaculty.map((faculty, index) => 
                createFacultyCard(faculty, index)
            ).join('');
            
            document.getElementById('facultyCount').textContent = filteredFaculty.length;
        }

        // Filter faculty with input sanitization
        function filterFaculty() {
            // Sanitize search input to prevent XSS
            const searchInput = document.getElementById('searchInput').value;
            const sanitizedSearchTerm = sanitizeHTML(searchInput).toLowerCase();
            const fieldFilter = document.getElementById('fieldFilter').value;
            
            // Validate field filter to prevent injection
            const validFields = ['', 'EKONOMI', 'KEWANGAN', 'PEMASARAN', 'PENGURUSAN', 'PENGANGKUTAN'];
            const safeFieldFilter = validFields.includes(fieldFilter) ? fieldFilter : '';
            
            filteredFaculty = facultyData.filter(faculty => {
                const matchesSearch = faculty.name.toLowerCase().includes(sanitizedSearchTerm) ||
                                      faculty.position.toLowerCase().includes(sanitizedSearchTerm) ||
                                      faculty.field.toLowerCase().includes(sanitizedSearchTerm);
                
                const matchesField = !safeFieldFilter || faculty.field === safeFieldFilter;
                
                return matchesSearch && matchesField;
            });
            
            renderFacultyGrid();
        }

        // Main profile routing function
        async function showProfile(index) {
            const faculty = facultyData[index];
            const cacheKey = `profile_${index}`;
            let profileData = getCached(cacheKey);

            if (!profileData) {
                // Fetch data if IDs exist
                const [orcidWorks, scholarData, scopusData, wosData, adScientificData] = await Promise.all([
                    faculty.orcidId ? fetchOrcidWorks(faculty.orcidId) : null,
                    faculty.scholarId ? fetchScholarData(faculty.scholarId, SERPAPI_KEY) : null,
                    faculty.scopusId ? fetchScopusData(faculty.scopusId, SERPAPI_KEY) : null,
                    faculty.wosId ? fetchWosData(faculty.wosId, SERPAPI_KEY) : null,
                    faculty.adScientificId ? fetchAdScientificData(faculty.adScientificId, SERPAPI_KEY) : null
                ]);
                profileData = { orcidWorks, scholarData, scopusData, wosData, adScientificData };
                setCached(cacheKey, profileData);
            }

            showEnhancedProfile(faculty, profileData);
        }

        // Show enhanced profile detail with sanitization
        function showEnhancedProfile(faculty, profileData) {
            // Sanitize all faculty data before rendering
            const sanitizedFaculty = {
                name: sanitizeHTML(faculty.name),
                position: sanitizeHTML(faculty.position),
                field: sanitizeHTML(faculty.field),
                phone: sanitizeHTML(faculty.phone),
                imageUrl: (faculty.imageUrl && isValidURL(faculty.imageUrl)) ? faculty.imageUrl : '',
                path: (faculty.path && isValidURL(faculty.path)) ? faculty.path : '',
                googleDriveLink: (faculty.googleDriveLink && isValidURL(faculty.googleDriveLink)) ? faculty.googleDriveLink : ''
            };
            
            const initials = getInitials(sanitizedFaculty.name);
            const fieldClass = getFieldClass(faculty.field); // Safe since it's from enum
            const { orcidWorks = [], scholarData = null, scopusData = null, wosData = null, adScientificData = null } = profileData;

            let researchSection = `
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Research Highlights</h2>
            `;

            if (orcidWorks && orcidWorks.length > 0) {
                researchSection += `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Recent Publications (ORCID)</h3>
                        <ul class="space-y-2">
                            ${orcidWorks.slice(0, 5).map(work => `<li class="text-gray-700">• ${work.title} (${work.year})</li>`).join('')}
                        </ul>
                        ${orcidWorks.length > 5 ? '<p class="text-sm text-gray-500 mt-2">... and ${orcidWorks.length - 5} more</p>' : ''}
                    </div>
                `;
            }

            if (scholarData) {
                researchSection += `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Google Scholar Metrics</h3>
                        <p class="text-gray-700 mb-2"><strong>Total Citations:</strong> ${scholarData.citedBy}</p>
                        ${scholarData.publications && scholarData.publications.length > 0 ? `
                            <h4 class="font-medium text-gray-800 mb-2">Top Publications:</h4>
                            <ul class="space-y-1">
                                ${scholarData.publications.slice(0, 3).map(pub => `<li class="text-sm text-gray-700">• ${pub.title} (${pub.year || 'N/A'})</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            }

            if (scopusData) {
                researchSection += `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Scopus Metrics</h3>
                        <p class="text-gray-700 mb-2"><strong>H-Index:</strong> ${scopusData.hIndex}</p>
                        <p class="text-gray-700 mb-2"><strong>Total Citations:</strong> ${scopusData.citedBy}</p>
                        ${scopusData.publications && scopusData.publications.length > 0 ? `
                            <h4 class="font-medium text-gray-800 mb-2">Top Publications:</h4>
                            <ul class="space-y-1">
                                ${scopusData.publications.slice(0, 3).map(pub => `<li class="text-sm text-gray-700">• ${pub.title} (${pub.year || 'N/A'})</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            }

            if (wosData) {
                researchSection += `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Web of Science Metrics</h3>
                        <p class="text-gray-700 mb-2"><strong>Total Citations:</strong> ${wosData.citedBy}</p>
                        ${wosData.publications && wosData.publications.length > 0 ? `
                            <h4 class="font-medium text-gray-800 mb-2">Top Publications:</h4>
                            <ul class="space-y-1">
                                ${wosData.publications.slice(0, 3).map(pub => `<li class="text-sm text-gray-700">• ${pub.title} (${pub.year || 'N/A'})</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            }

            if (adScientificData) {
                researchSection += `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">AD Scientific Index</h3>
                        <p class="text-gray-700 mb-2"><strong>Rank:</strong> ${adScientificData.rank}</p>
                    </div>
                `;
            }

            if (!orcidWorks && !scholarData && !scopusData && !wosData && !adScientificData) {
                researchSection += `
                    <p class="text-gray-700 leading-relaxed">
                        A detailed portfolio for this faculty member, including research interests, publications, achievements, and a detailed biography, will be available here soon.
                    </p>
                `;
            }

            const profileHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-50 to-indigo-50">
                    <div class="profile-header text-white relative z-10">
                        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                            <button onclick="showHomepage()" class="back-button inline-flex items-center text-white hover:text-gray-200 mb-8 px-4 py-2 rounded-xl">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                Back to Directory
                            </button>
                            
                            <div class="flex flex-col lg:flex-row items-start lg:items-center space-y-6 lg:space-y-0 lg:space-x-8">
                                <div class="relative">
                                    ${sanitizedFaculty.imageUrl ? `
                                        <div class="w-32 h-32 rounded-3xl overflow-hidden backdrop-blur-sm border-4 border-white border-opacity-30 shadow-2xl">
                                            <img src="${sanitizedFaculty.imageUrl}" alt="${sanitizedFaculty.name}" class="w-full h-full object-cover" loading="lazy">
                                        </div>
                                    ` : `
                                        <div class="w-32 h-32 bg-white bg-opacity-20 rounded-3xl flex items-center justify-center text-white font-bold text-3xl backdrop-blur-sm border border-white border-opacity-30">
                                            ${initials}
                                        </div>
                                    `}
                                    <div class="absolute -bottom-3 -right-3 w-10 h-10 bg-green-500 rounded-full border-4 border-white flex items-center justify-center shadow-lg">
                                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h1 class="text-4xl lg:text-5xl font-bold mb-3 leading-tight">${sanitizedFaculty.name}</h1>
                                    <p class="text-xl text-indigo-100 mb-4 font-medium">${sanitizedFaculty.position}</p>
                                    <div class="flex flex-wrap gap-3">
                                        <span class="field-badge ${fieldClass} text-sm">${sanitizedFaculty.field}</span>
                                        <span class="glass px-4 py-2 rounded-full text-sm font-medium">📞 ${sanitizedFaculty.phone}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 -mt-8 relative z-20">
                        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8">
                            ${researchSection}
                            ${sanitizedFaculty.path ? `
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <a href="${sanitizedFaculty.path}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                        View Full Portfolio on GitHub
                                    </a>
                                </div>
                            ` : ''}
                            ${sanitizedFaculty.googleDriveLink ? `
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <a href="${sanitizedFaculty.googleDriveLink}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                                        View Additional Resources on Google Drive
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('profileView').innerHTML = profileHTML;
            document.getElementById('homepage').classList.add('hidden');
            document.getElementById('profileView').classList.remove('hidden');
        }

        // Show homepage
        function showHomepage() {
            document.getElementById('profileView').classList.add('hidden');
            document.getElementById('homepage').classList.remove('hidden');
        }

        // Sort faculty
        function sortFaculty() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredFaculty.sort((a, b) => {
                switch(sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'position': return a.position.localeCompare(b.position);
                    case 'field': return a.field.localeCompare(b.field);
                    default: return 0;
                }
            });
            
            renderFacultyGrid();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('fieldFilter').value = '';
            document.getElementById('sortBy').value = 'name';
            filteredFaculty = [...facultyData];
            renderFacultyGrid();
        }

        // Enhanced filter with debounce
        let filterTimeout;
        function debouncedFilter() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                filterFaculty();
            }, 300);
        }

        // --- NEW/UPDATED AI Functions (Vanilla JS) ---

        async function callGeminiAPI(prompt) {
            showLoadingInModal();
            const apiUrl = `${GEMINI_API_URL_BASE}?key=${GEMINI_API_KEY}`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    let errorMessage = `API request failed with status ${response.status}`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += `: ${errorData.error.message}`;
                    }
                    if (response.status === 400 && errorData.error?.message.toLowerCase().includes("api key not valid")) {
                            errorMessage += " Please check if your API key is correct and has the Gemini API enabled.";
                    } else if (response.status === 403) {
                        errorMessage += " Permission denied. This might be due to an incorrect API key or insufficient permissions for the key.";
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason === "SAFETY") {
                    console.warn("Gemini API response blocked due to safety settings:", result.candidates[0]);
                    return "The AI-generated content could not be displayed due to safety restrictions. Please try a different prompt or check your safety settings.";
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Failed to parse AI response. The structure was unexpected or content was missing.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                let displayError = error.message;
                if (error.message.includes("API key")) {
                    displayError = "There seems to be an issue with the API key. Please ensure it's correct and has the necessary permissions. (Details in console)";
                } else if (error.message.includes("Failed to fetch")) {
                        displayError = "Network error: Could not connect to the AI service. Please check your internet connection. (Details in console)";
                }
                return `Error: ${displayError}`;
            }
        }

        // Global modal variables
        let aiModal, modalTitle, modalBody, closeModalButton, copyAiContentButton;
        // NEW Contact Modal variables
        let contactModal, contactModalTitle, closeContactModalButton, contactForm;
        let currentContactFaculty = null; // Store the currently selected faculty for contact

        function showLoadingInModal() {
            if (modalTitle) modalTitle.textContent = 'AI Generated Content';
            if (modalBody) modalBody.innerHTML = '<div class="spinner"></div><p style="text-align: center; color: #6b7280;">Generating content with AI...</p>';
            if (aiModal) aiModal.classList.add('active');
        }

        function displayInModal(title, content) {
            if (modalTitle) modalTitle.textContent = title;
            if (modalBody) {
                // Format markdown-like text to HTML
                let formattedContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italics
                    .replace(/\n\*/g, '<br>•') // Bullet points
                    .replace(/\n/g, '<br>'); // Newlines
                
                // Handle formatted titles (like "**Expertise Snapshot:**")
                formattedContent = formattedContent.replace(/<br><strong>(.*?):<\/strong>/g, '<br><br><strong style="color: #6d28d9; font-size: 1.1em;">$1:</strong>');

                modalBody.innerHTML = formattedContent;
            }
            if (aiModal) aiModal.classList.add('active');
        }

        // --- UPDATED handleAiClick function ---
        async function handleAiClick(event, facultyIndex, type) {
            event.stopPropagation(); // Stop click from propagating to the card's link
            
            // Only 'pitch' type is left
            if (type !== 'pitch') return; 

            const faculty = facultyData[facultyIndex];
            
            // NEW refined prompt as requested
            let prompt = `You are an expert academic and industry liaison. A global visitor is exploring this faculty member's profile and is curious about collaboration.
            
            Generate a punchy and concise (3-4 paragraphs max) profile highlighting potential collaboration opportunities.
            
            **Faculty Member Details:**
            * **Name:** ${faculty.name}
            * **Position:** ${faculty.position}
            * **Field of Expertise:** ${faculty.field}
            
            **Your Task:**
            1.  Start with a strong, engaging summary of their expertise based on their position and field.
            2.  **Critically, identify and recommend 3-5 specific areas or topics for collaboration.** These should be logical extensions of their field (e.g., if "Finance", suggest "FinTech research", "Sustainable Finance modeling", "Corporate finance consulting").
            3.  Conclude with a call to action inviting collaboration.
            4.  The tone should be professional, enthusiastic, and globally accessible.
            
            **Output Format:**
            **Expertise Snapshot:**
            [Your summary here]
            
            **Potential Collaboration Areas:**
            * [Recommendation 1]
            * [Recommendation 2]
            * [Recommendation 3]
            
            **Get in Touch:**
            [Your call to action here]`;
                
            let title = `Curious about ${faculty.name}? (AI-Generated)`;

            const aiResponse = await callGeminiAPI(prompt);
            displayInModal(title, aiResponse);
        }
        // Make handleAiClick global so onclick can find it
        window.handleAiClick = handleAiClick;

        // --- NEW handleContactClick function ---
        function handleContactClick(event, facultyIndex) {
            event.stopPropagation(); // Stop click from propagating to the card's link
            const faculty = facultyData[facultyIndex];
            currentContactFaculty = faculty; // Store the selected faculty
            
            if (contactModal) {
                contactModalTitle.innerHTML = `Initiate Contact with <span style="color: #047857;">${faculty.name}</span>`;
                contactForm.reset(); // Clear any previous input
                contactModal.classList.add('active');
            }
        }
        // Make it global
        window.handleContactClick = handleContactClick;


        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('input', debouncedFilter);
            document.getElementById('fieldFilter').addEventListener('change', filterFaculty);
            document.getElementById('sortBy').addEventListener('change', sortFaculty);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            const audio = document.getElementById('backgroundMusic');
            const audioControl = document.getElementById('audioControl');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');

            audioControl.addEventListener('click', () => {
                if (audio.paused) {
                    audio.play();
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                } else {
                    audio.pause();
                    pauseIcon.classList.add('hidden');
                    playIcon.classList.remove('hidden');
                }
            });

            // --- AI Modal Event Listeners ---
            aiModal = document.getElementById('aiModal');
            modalTitle = document.getElementById('modalTitle');
            modalBody = document.getElementById('modalBody');
            closeModalButton = document.getElementById('closeModal');
            copyAiContentButton = document.getElementById('copyAiContent');

            function closeAiModal() {
                if (aiModal) aiModal.classList.remove('active');
            }

            // Close modal listeners
            if (closeModalButton) closeModalButton.addEventListener('click', closeAiModal);
            if (aiModal) {
                aiModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeAiModal();
                    }
                });
            }
            
            // Copy to clipboard listener
            if (copyAiContentButton) {
                copyAiContentButton.addEventListener('click', function() {
                    const textToCopy = modalBody.innerText; // Use innerText to get text without HTML
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        this.textContent = 'Copied!';
                        setTimeout(() => this.textContent = 'Copy to Clipboard', 2000);
                    }, (err) => {
                        console.error('Failed to copy text: ', err);
                        this.textContent = 'Copy Failed';
                        setTimeout(() => this.textContent = 'Copy to Clipboard', 2000);
                    });
                });
            }
            // --- End of AI Modal Listeners ---

            // --- NEW Contact Modal Listeners ---
            contactModal = document.getElementById('contactModal');
            contactModalTitle = document.getElementById('contactModalTitle');
            closeContactModalButton = document.getElementById('closeContactModal');
            contactForm = document.getElementById('contactForm');

            function closeContactModal() {
                if (contactModal) contactModal.classList.remove('active');
            }

            if (closeContactModalButton) closeContactModalButton.addEventListener('click', closeContactModal);
            
            if (contactModal) {
                contactModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeContactModal();
                    }
                });
            }

            if (contactForm) {
                contactForm.addEventListener('submit', function(event) {
                    event.preventDefault(); // Prevent actual form submission
                    
                    // Get and sanitize form data
                    const visitorEmail = document.getElementById('contactEmail').value.trim();
                    const visitorPhone = document.getElementById('contactPhone').value.trim() || 'Not provided';
                    const visitorMessage = document.getElementById('contactMessage').value.trim() || '';
                    
                    // Validate email format
                    if (!isValidEmail(visitorEmail)) {
                        alert('Please enter a valid email address.');
                        return;
                    }
                    
                    // Sanitize inputs to prevent injection
                    const sanitizedEmail = sanitizeHTML(visitorEmail);
                    const sanitizedPhone = sanitizeHTML(visitorPhone);
                    const sanitizedMessage = sanitizeHTML(visitorMessage);
                    
                    // Check if faculty is selected and has an email
                    if (!currentContactFaculty) {
                        alert('Error: No faculty member selected. Please try again.');
                        closeContactModal();
                        return;
                    }
                    
                    if (!currentContactFaculty.email || !isValidEmail(currentContactFaculty.email)) {
                        alert('Sorry, a valid email address is not available for this faculty member.');
                        closeContactModal();
                        return;
                    }
                    
                    // Construct email subject and body with sanitized data
                    const subject = encodeURIComponent(`Contact Request from Faculty Portfolio Website`);
                    let body = `Dear ${sanitizeHTML(currentContactFaculty.name)},\n\n`;
                    body += `I would like to get in touch with you.\n\n`;
                    body += `My Contact Details:\n`;
                    body += `Email: ${sanitizedEmail}\n`;
                    body += `Phone: ${sanitizedPhone}\n\n`;
                    
                    if (sanitizedMessage) {
                        body += `Message:\n${sanitizedMessage}\n\n`;
                    }
                    
                    body += `\nBest regards`;
                    
                    const encodedBody = encodeURIComponent(body);
                    
                    // Create mailto link and open it
                    const mailtoLink = `mailto:${encodeURIComponent(currentContactFaculty.email)}?subject=${subject}&body=${encodedBody}`;
                    window.location.href = mailtoLink;
                    
                    // Show confirmation and close modal
                    setTimeout(() => {
                        alert(`Your email client should open shortly. If not, please email ${currentContactFaculty.email} directly.`);
                        closeContactModal();
                    }, 500);
                });
            }
            // --- End of NEW Contact Modal Listeners ---

            // --- Auth Modal Listeners ---
            const authButton = document.getElementById('authButton');
            const authModal = document.getElementById('authModal');
            const closeAuthModalButton = document.getElementById('closeAuthModal');
            const googleSignInButton = document.getElementById('googleSignInButton');
            const staffIdForm = document.getElementById('staffIdForm');

            // Auth button click - toggle between sign in and sign out
            if (authButton) {
                authButton.addEventListener('click', () => {
                    if (currentAuthUser) {
                        // User is signed in, so sign out
                        signOut();
                    } else {
                        // User is not signed in, open modal
                        openAuthModal();
                    }
                });
            }

            // Close auth modal
            if (closeAuthModalButton) {
                closeAuthModalButton.addEventListener('click', closeAuthModal);
            }

            // Close modal when clicking outside
            if (authModal) {
                authModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeAuthModal();
                    }
                });
            }

            // Google Sign In button
            if (googleSignInButton) {
                googleSignInButton.addEventListener('click', signInWithGoogle);
            }

            // Staff ID form submission
            if (staffIdForm) {
                staffIdForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const staffId = document.getElementById('staffIdInput').value.trim();
                    
                    if (staffId) {
                        const verified = verifyStaffId(staffId);
                        if (verified) {
                            setTimeout(() => {
                                closeAuthModal();
                            }, 2000);
                        }
                    } else {
                        showAuthStatus('Please enter a staff ID', 'error');
                    }
                });
            }
            // --- End Auth Modal Listeners ---

            renderFacultyGrid();
        });
    </script>
</body>
</html>
